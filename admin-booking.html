<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Manage Bookings | BookBuster</title>
  <link rel="stylesheet" href="CSS/style.css" />
</head>
<body>

  <nav>
    <div class="logo-container">
      <a href="index.html">
        <img src="assets/images/Banner.png" alt="BookBuster Logo">
      </a>
    </div>
    <div class="nav-links">
      <a href="index.html">Home</a>
      <a href="dashboard.html">Movies</a>
      <a href="admin-schedule.html">Schedule</a>
      <a href="admin-booking.html" class="active">Bookings</a>
      <a href="#" id="logoutBtn" style="background-color: #ff4d4d; color: white;">Logout</a>
    </div>
  </nav>

  <div class="hero" style="margin-top: 100px;">
    <h1>Box Office</h1>
    <p class="lead">Real-time Seat Reservation System.</p>
  </div>

  <section class="features">
    
    <div style="display: flex; flex-wrap: wrap; gap: 40px; justify-content: center;">
        
        <form id="addBookingForm" style="flex: 1; min-width: 320px;">
            <h3 style="color:white; margin-bottom:15px;">Sell Ticket</h3>
            
            <label>Customer Name:</label><br>
            <input type="text" id="custName" required placeholder="John Doe"><br><br>

            <label>Select Showtime:</label><br>
            <select id="showtimeSelect" required style="width:100%; padding:12px; background:#222; color:#fff; border:1px solid #444; border-radius:6px; margin-bottom:15px;">
                <option value="">Loading showtimes...</option>
            </select><br>

            <input type="hidden" id="seatCount" value="0">
            <input type="hidden" id="seatLabels" value="">
            <input type="hidden" id="showtimeDetailsText" value="">
            
            <div style="background: rgba(0,0,0,0.5); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #333;">
                <div class="screen">SCREEN</div>
                
                <p id="mapLoading" style="display:none; color:#ffbd59; font-size:12px;">Checking availability...</p>
                
                <div id="seatMap" class="seat-grid"></div>
                <p id="seatDisplay" style="color: #ffbd59; font-weight: bold; margin-top:15px; min-height: 20px;">Select a Showtime first</p>
            </div>
            <br>

            <button type="submit" id="submitBtn" disabled>Confirm Booking</button>
        </form>

        <div style="flex: 1; min-width: 300px; text-align: left;">
            <h3 style="color:white; margin-bottom:15px;">Recent Sales</h3>
            <div id="bookingList">
                <p>Loading...</p>
            </div>
        </div>
    </div>

  </section>

  <script type="module">
    import { db, auth } from "./bookbuster.js";
    import { collection, addDoc, getDocs, query, orderBy, where, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

    // 1. Generate Chairs
    const seatMap = document.getElementById('seatMap');
    const seatDisplay = document.getElementById('seatDisplay');
    const seatCountInput = document.getElementById('seatCount');
    const seatLabelsInput = document.getElementById('seatLabels');
    const submitBtn = document.getElementById('submitBtn');

    const rows = ['A', 'B', 'C', 'D']; 
    const seatsPerRow = 8;             

    rows.forEach(rowLetter => {
        for (let i = 1; i <= seatsPerRow; i++) {
            const seatLabel = rowLetter + i; 
            
            const seat = document.createElement('div');
            seat.className = 'seat';
            seat.textContent = seatLabel;
            seat.dataset.label = seatLabel;
            
            seat.addEventListener('click', () => {
                if (seat.classList.contains('taken')) return;
                seat.classList.toggle('selected');
                updateSelection();
            });
            seatMap.appendChild(seat);
        }
    });

    function updateSelection() {
        const selectedEls = document.querySelectorAll('.seat.selected');
        const count = selectedEls.length;
        const labels = Array.from(selectedEls).map(el => el.dataset.label);
        
        seatCountInput.value = count;
        seatLabelsInput.value = labels.join(", ");

        if (count > 0) {
            seatDisplay.textContent = `Selected: ${labels.join(", ")}`;
            submitBtn.disabled = false;
        } else {
            seatDisplay.textContent = "Please select seats";
            submitBtn.disabled = true;
        }
    }

    // 2. Load Occupied Seats (Using IDs now!)
    async function checkAvailability(showtimeId) {
        // Reset Map
        document.querySelectorAll('.seat').forEach(s => {
            s.classList.remove('taken', 'selected');
        });
        seatDisplay.textContent = "Checking availability...";
        document.getElementById('mapLoading').style.display = 'block';

        try {
            // FIXED: Query by 'showtimeId' (Stable) instead of 'details' (Unstable text)
            const q = query(collection(db, "bookings"), where("showtimeId", "==", showtimeId));
            const snapshot = await getDocs(q);
            
            let takenSeats = [];
            
            snapshot.forEach(doc => {
                const data = doc.data();
                if (data.seatNumbers) {
                    const seats = data.seatNumbers.split(', ');
                    takenSeats.push(...seats);
                }
            });

            // Mark taken seats
            document.querySelectorAll('.seat').forEach(seat => {
                if (takenSeats.includes(seat.dataset.label)) {
                    seat.classList.add('taken');
                }
            });

            seatDisplay.textContent = "Select seats";

        } catch (error) {
            console.error("Error checking seats:", error);
            seatDisplay.textContent = "Error loading map";
        } finally {
            document.getElementById('mapLoading').style.display = 'none';
        }
    }

    // Listener: Handle Dropdown Change
    document.getElementById('showtimeSelect').addEventListener('change', (e) => {
        const id = e.target.value;
        const text = e.target.options[e.target.selectedIndex].text;
        
        document.getElementById('showtimeDetailsText').value = text;

        if (id) {
            checkAvailability(id);
        } else {
            // Clear map if they select the default option
            document.querySelectorAll('.seat').forEach(s => s.classList.remove('taken', 'selected'));
            submitBtn.disabled = true;
        }
    });

    // 3. Auth & Init
    onAuthStateChanged(auth, (user) => {
      if (!user) {
          localStorage.removeItem('userLoggedIn');
          window.location.href = "login.html";
      } else {
          loadShowtimes();
          loadBookings();
      }
    });

    // 4. Load Showtimes (Store ID in value)
    async function loadShowtimes() {
        const select = document.getElementById('showtimeSelect');
        try {
            const q = query(collection(db, "showtimes"), orderBy("datetime", "asc"));
            const snapshot = await getDocs(q);
            
            select.innerHTML = '<option value="">-- Choose Showtime --</option>';
            snapshot.forEach(docSnap => {
                const s = docSnap.data();
                const id = docSnap.id; // Get the unique ID
                const date = new Date(s.datetime).toLocaleString();
                
                const option = document.createElement('option');
                option.value = id; // Store ID (Stable)
                option.textContent = `${s.movieTitle} - ${date} (${s.cinema})`; // Show Text (Readable)
                select.appendChild(option);
            });
        } catch (error) {
            console.error(error);
        }
    }

    // 5. Submit Booking
    document.getElementById('addBookingForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('custName').value;
        const showtimeId = document.getElementById('showtimeSelect').value;
        const showtimeText = document.getElementById('showtimeDetailsText').value; // Saved for display
        const count = document.getElementById('seatCount').value;
        const specificSeats = document.getElementById('seatLabels').value;

        try {
            await addDoc(collection(db, "bookings"), {
                customer: name,
                showtimeId: showtimeId, // The Link!
                details: showtimeText,  // Just for reading
                seatCount: count,
                seatNumbers: specificSeats, 
                timestamp: new Date()
            });
            alert("Ticket Sold!");
            
            document.getElementById('addBookingForm').reset();
            updateSelection();
            checkAvailability(showtimeId); 
            loadBookings();
        } catch (error) {
            alert("Error: " + error.message);
        }
    });

    // 6. Load Recent List
    async function loadBookings() {
        const list = document.getElementById('bookingList');
        try {
            const q = query(collection(db, "bookings"), orderBy("timestamp", "desc"));
            const snapshot = await getDocs(q);

            list.innerHTML = "";
            snapshot.forEach(docSnap => {
                const b = docSnap.data();
                const id = docSnap.id; 

                const div = document.createElement('div');
                div.className = 'booking-row';
                div.innerHTML = `
                    <div style="flex: 1;">
                        <strong style="color:#ffbd59;">${b.customer}</strong>
                        <div style="font-size:13px; color:#aaa;">${b.details}</div>
                        <div style="font-size:12px; color:#4CAF50;">Seats: ${b.seatNumbers}</div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-weight:bold; margin-bottom:5px;">${b.seatCount} Tix</div>
                        <button onclick="deleteTicket('${id}', '${b.showtimeId}')" style="background:#f44336; padding:5px 8px; font-size:11px; width:auto; border-radius:4px; border:none; color:white; cursor:pointer;">Refund</button>
                    </div>
                `;
                list.appendChild(div);
            });
        } catch (error) {
            console.error(error);
        }
    }

    // 7. Delete Logic
    window.deleteTicket = async (bookingId, showtimeId) => {
        if(confirm("Refund this ticket?")) {
            try {
                await deleteDoc(doc(db, "bookings", bookingId));
                
                loadBookings(); // Refresh list

                // If map is currently showing THIS showtime, refresh the map too
                const currentSelection = document.getElementById('showtimeSelect').value;
                if (currentSelection === showtimeId) {
                    checkAvailability(currentSelection);
                }
                
            } catch (error) {
                alert("Error deleting: " + error.message);
            }
        }
    }

    document.getElementById('logoutBtn').addEventListener('click', () => {
        signOut(auth).then(() => {
            localStorage.removeItem('userLoggedIn');
            window.location.href = "login.html";
        });
    });
  </script>
</body>
</html>