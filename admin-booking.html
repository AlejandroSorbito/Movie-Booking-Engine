<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Manage Bookings | BookBuster</title>
  <link rel="stylesheet" href="CSS/style.css" />
  <style>
      /* --- SEAT MAP STYLES --- */
      .seat-grid {
          display: grid;
          grid-template-columns: repeat(8, 1fr); /* 8 seats per row */
          gap: 8px;
          margin: 20px 0;
          max-width: 400px;
      }
      .seat {
          height: 35px;
          background: #444;
          border-radius: 6px;
          border: 1px solid #555;
          cursor: pointer;
          transition: 0.2s;
          
          /* TEXT STYLES (New) */
          color: #aaa;
          font-size: 11px;
          font-weight: bold;
          display: flex;
          justify-content: center;
          align-items: center;
      }
      .seat:hover { background: #666; color: #fff; }
      
      /* Selected State (Gold) */
      .seat.selected { 
          background: #ffbd59; 
          color: #000; 
          border-color: #e6a800;
          box-shadow: 0 0 8px rgba(255, 189, 89, 0.4); 
      }

      .screen {
          width: 100%;
          height: 8px;
          background: #ddd;
          border-radius: 4px;
          margin-bottom: 25px;
          box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
          text-align: center;
          line-height: 8px;
          font-size: 9px;
          color: #000;
          letter-spacing: 2px;
          text-transform: uppercase;
      }
      .booking-row { background: #1a1a1a; padding: 15px; margin-bottom: 5px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; color: #ddd; }
  </style>
</head>
<body>

  <nav>
    <a href="index.html">Home</a>
    <a href="dashboard.html">Movies</a>
    <a href="admin-schedule.html">Schedule</a>
    <a href="admin-bookings.html" class="active">Bookings</a>
    <a href="#" id="logoutBtn" style="background-color: #ff4d4d; color: white;">Logout</a>
  </nav>

  <div class="hero" style="margin-top: 100px;">
    <h1>Box Office</h1>
    <p class="lead">Select a showtime and click specific seats.</p>
  </div>

  <section class="features">
    
    <div style="display: flex; flex-wrap: wrap; gap: 40px; justify-content: center;">
        
        <form id="addBookingForm" style="flex: 1; min-width: 320px;">
            <h3 style="color:white; margin-bottom:15px;">Sell Ticket</h3>
            
            <label>Customer Name:</label><br>
            <input type="text" id="custName" required placeholder="John Doe"><br><br>

            <label>Select Showtime:</label><br>
            <select id="showtimeSelect" required style="width:100%; padding:12px; background:#222; color:#fff; border:1px solid #444; border-radius:6px; margin-bottom:15px;">
                <option value="">Loading showtimes...</option>
            </select><br>

            <input type="hidden" id="seatCount" value="0">
            <input type="hidden" id="seatLabels" value=""> <div style="background: rgba(0,0,0,0.5); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid #333;">
                <div class="screen">SCREEN</div>
                <div id="seatMap" class="seat-grid">
                    </div>
                <p id="seatDisplay" style="color: #ffbd59; font-weight: bold; margin-top:15px; min-height: 20px;">No seats selected</p>
            </div>
            <br>

            <button type="submit">Confirm Booking</button>
        </form>

        <div style="flex: 1; min-width: 300px; text-align: left;">
            <h3 style="color:white; margin-bottom:15px;">Recent Sales</h3>
            <div id="bookingList">
                <p>Loading...</p>
            </div>
        </div>
    </div>

  </section>

  <script type="module">
    import { db, auth } from "./bookbuster.js";
    import { collection, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

    // 1. Generate LABELED Chairs (A1, A2...)
    const seatMap = document.getElementById('seatMap');
    const seatDisplay = document.getElementById('seatDisplay');
    const seatCountInput = document.getElementById('seatCount');
    const seatLabelsInput = document.getElementById('seatLabels'); // Hidden field for DB

    const rows = ['A', 'B', 'C', 'D']; // 4 Rows
    const seatsPerRow = 8;             // 8 Cols

    rows.forEach(rowLetter => {
        for (let i = 1; i <= seatsPerRow; i++) {
            const seatLabel = rowLetter + i; // e.g., "A1"
            
            const seat = document.createElement('div');
            seat.className = 'seat';
            seat.textContent = seatLabel; // Show "A1" on the chair
            seat.dataset.label = seatLabel; // Store it for logic
            
            seat.addEventListener('click', () => {
                seat.classList.toggle('selected');
                updateSelection();
            });
            seatMap.appendChild(seat);
        }
    });

    function updateSelection() {
        const selectedEls = document.querySelectorAll('.seat.selected');
        const count = selectedEls.length;
        
        // Create a list of names like ["A1", "A2"]
        const labels = Array.from(selectedEls).map(el => el.dataset.label);
        
        seatCountInput.value = count;
        seatLabelsInput.value = labels.join(", "); // Store string "A1, A2"

        if (count > 0) {
            seatDisplay.textContent = `Selected: ${labels.join(", ")}`;
        } else {
            seatDisplay.textContent = "No seats selected";
        }
    }

    // 2. Auth Check & Load Data
    onAuthStateChanged(auth, (user) => {
      if (!user) {
          localStorage.removeItem('userLoggedIn');
          window.location.href = "login.html";
      } else {
          loadShowtimes();
          loadBookings();
      }
    });

    // 3. Load Showtimes
    async function loadShowtimes() {
        const select = document.getElementById('showtimeSelect');
        try {
            const q = query(collection(db, "showtimes"), orderBy("datetime", "asc"));
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                select.innerHTML = '<option value="">No upcoming shows found.</option>';
                return;
            }

            select.innerHTML = '<option value="">-- Choose Showtime --</option>';
            snapshot.forEach(doc => {
                const s = doc.data();
                const date = new Date(s.datetime).toLocaleString();
                const option = document.createElement('option');
                option.value = `${s.movieTitle} | ${date} | ${s.cinema}`;
                option.textContent = `${s.movieTitle} - ${date} (${s.cinema})`;
                select.appendChild(option);
            });
        } catch (error) {
            console.error(error);
            select.innerHTML = '<option value="">Error loading list</option>';
        }
    }

    // 4. Submit Booking (Now with Seat Numbers!)
    document.getElementById('addBookingForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = document.getElementById('custName').value;
        const details = document.getElementById('showtimeSelect').value;
        const count = document.getElementById('seatCount').value;
        const specificSeats = document.getElementById('seatLabels').value; // Get "A1, A2"

        if (count == 0) {
            alert("Please select at least one seat!");
            return;
        }
        if (!details) {
            alert("Please select a showtime.");
            return;
        }

        try {
            await addDoc(collection(db, "bookings"), {
                customer: name,
                details: details,
                seatCount: count,
                seatNumbers: specificSeats, // Saving "A1, A2" to DB
                timestamp: new Date()
            });
            alert("Ticket Sold for seats: " + specificSeats);
            
            // Reset form
            document.getElementById('addBookingForm').reset();
            document.querySelectorAll('.seat.selected').forEach(s => s.classList.remove('selected'));
            updateSelection();
            
            loadBookings();
        } catch (error) {
            alert("Error: " + error.message);
        }
    });

    // 5. Load Recent Bookings
    async function loadBookings() {
        const list = document.getElementById('bookingList');
        try {
            const q = query(collection(db, "bookings"), orderBy("timestamp", "desc"));
            const snapshot = await getDocs(q);

            list.innerHTML = "";
            snapshot.forEach(doc => {
                const b = doc.data();
                const div = document.createElement('div');
                div.className = 'booking-row';
                div.innerHTML = `
                    <div>
                        <strong style="color:#ffbd59;">${b.customer}</strong>
                        <div style="font-size:13px; color:#aaa;">${b.details}</div>
                        <div style="font-size:12px; color:#4CAF50;">Seats: ${b.seatNumbers || "N/A"}</div>
                    </div>
                    <div style="font-weight:bold;">${b.seatCount} Tix</div>
                `;
                list.appendChild(div);
            });
        } catch (error) {
            console.error(error);
        }
    }

    document.getElementById('logoutBtn').addEventListener('click', () => {
        signOut(auth).then(() => {
            localStorage.removeItem('userLoggedIn');
            window.location.href = "login.html";
        });
    });
  </script>
</body>
</html>